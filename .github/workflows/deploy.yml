name: Deploy to Cloudflare Pages

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        permissions:
            contents: read

        steps:
            - name: Checkout public repo
              uses: actions/checkout@v4

              - name: Assert PRIVATE_REPO_TOKEN is available
                run: |
                  if [ -z "${{ secrets.PRIVATE_REPO_TOKEN }}" ]; then
                    echo "PRIVATE_REPO_TOKEN is empty or not available to this job."
                    exit 1
                  fi

            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}
                  token: ${{ secrets.PRIVATE_REPO_TOKEN }}
                  path: private-repo
                  fetch-depth: 1

            - name: Prepare directories
              run: |
                  mkdir -p private
                  mkdir -p private/images

            - name: Copy private data to public repo
              run: |
                  cp private-repo/portfolio.csv ./private/
                  cp -r private-repo/images/* ./private/images/

            - name: Cache Node modules
              uses: actions/cache@v4
              with:
                path: ~/.npm
                key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                restore-keys: |
                  ${{ runner.os }}-npm-

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20.17.0'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Ensure local wrangler is installed
              run: npm install --no-save wrangler@3.67.0

            - name: Build site
              run: npm run build
              env:
                PORTFOLIO_CSV_PATH: private/portfolio.csv

            - name: Deploy to Cloudflare Pages
              run: |
                npx wrangler pages deploy site \
                  --project-name=${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
              env:
                CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                CF_PAGES_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
